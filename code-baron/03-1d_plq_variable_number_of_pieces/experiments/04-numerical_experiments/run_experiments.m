yalmip('clear')
% a = [-0.0019795	-0.0025	0	0.0025	-0.0025	0	0	0	0	0	0	0	0	0	0.005	-0.0025	-0.0025	0.005	-0.005	-4.7835e-16	0.0050044];
% b = [0.07918	0	-0.1	-0.1	0	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	0.1	0	-0.1	0.1	-0.1	-0.1];
% c = [2316.2	2317	2316	2314	2313	2312	2310	2308	2306	2304	2302	2300	2298	2296	2294	2294	2295	2294	2294	2294	2292];
% sId = [0	20	40	60	80	100	120	140	160	180	200	220	240	260	280	300	320	340	360	380	400];
% eId = [20	40	60	80	100	120	140	160	180	200	220	240	260	280	300	320	340	360	380	400	419.98];
% f=[a;b;c];
% pieces = [0	20	40	60	80	100	120	140	160	180	200	220	240	260	280	300	320	340	360	380	400	419.98 ];
% visualize(f,pieces,f,pieces);
% pieces = [0	20	40	60	80	100	120	140	149.07	160	180	200	220	240	260	261.36	280	300	320	340	360	380	388.83	400	420	440	460 473.74];
%  a = [0.001448	-0.0025	0	0	0.0025	-0.0025	1.4225e-16	0.011026	-0.0091484	0	0	0	0	0	0.073752	-0.0053636	-1.0187e-15	5.0914e-16	0	0	2.55e-16	0.01132	-0.0089559	0	0	0	0.0019803];
% b = [-0.05792	0	-0.1	-0.1	-0.1	0	-0.1	-0.1	0.1	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	0.1	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	0.1	-0.1	-0.1	-0.1	-0.1];
% c = [1912.6	1912	1911	1909	1907	1906	1905	1903	1903	1903	1901	1899	1897	1895	1893	1893	1893	1891	1889	1887	1885	1883	1883	1883	1881	1879	1877];
% f=[a;b;c];
% pieces = [0	20	40	60	80	100	120	140	149.07	160 ];
%  a = [0.001448	-0.0025	0	0	0.0025	-0.0025	1.4225e-16	0.011026	-0.0091484	 ];
% b = [-0.05792	0	-0.1	-0.1	-0.1	0	-0.1	-0.1	0.1	 ];
% c = [1912.6	1912	1911	1909	1907	1906	1905	1903	1903	 ];
% f=[a;b;c];
% visualize(f,pieces,f,pieces);
% 
% pieces = [-inf(),-10,-15, -5, 0, 5, 10,15,inf()];
% f = [0,0,0, 0, 0, 0,0,0;
%     1,1,1, 1, -1, 1,1,1;
%     5,5,5, 5, 5, -5,-5,-5];


% pieces = [0	11.579	99.998	111.58	211.58	300	304.39	311.58	316.15	327.92	329.49	336.15	411.58	511.58	611.58	711.58	800	811.58	911.58	984.58	991.24	992.81	1000	1004.6	1011.6	1016.3	1111.6	1211.6	1230.3	1242.1	1253.8	1255.4	1262.1	1311.6	1386.3	1393	1394.5	1400	1406.3	1411.6	1418.1	1500	1511.6	1611.6	1700	1711.6	1734.1	1754.1	1767.5	1774.1	1800	1811.6	1911.6	2011.6	2100	2111.6	2141.3	2148	2161.3	2181.3	2200	2211.6	2311.6	2400	2411.6	2462.9	2482	2495.3	2501	2502	2511.6	2600	2611.6	2700	2711.6	2800	2811.6	2900	2900.3	2901.2	2906.9	2911.6	2920.3	2939.3	3011.6	3100	3111.6	3211.6	3311.6	3411.6	3511.6	3611.6	3700	3711.6	3800	3811.6	3911.6 4000];
% a = [0.0037232	-0.00062206	0.0047494	-0.00065002	0.00072033	-0.011943	0.0072828	-0.011457	0.0044526	-0.033253	0.0078653	-0.00051871	0.00045868	-0.00055868	0.00055868	0.0001504	-0.00052681	9.7343e-05	-0.00042794	-0.0055942	0.023651	-0.0051827	0.0081421	-0.0053203	0.007824	4.9799e-05	-0.00016743	0.0021435	-0.00072598	0.00072591	-0.059383	0.014045	-0.00066542	-0.00037007	0.004152	-0.017553	0.0050597	-0.0043895	0.005238	-0.0042636	0.00018853	-0.00028005	0.00023243	2.2566e-05	-0.0040793	0.00012844	-0.00042804	0.0043899	-0.0087929	-0.00072525	0.000839	0.00036651	0.00043349	-4.7303e-05	-0.006476	0.00025989	0.008938	-0.0044623	0.00047634	0.0021662	-0.0034955	0.00050473	8.3508e-05	0.00096079	-0.00038146	-0.00030547	-0.0034993	0.0081788	-0.049014	0.004859	0.00023949	-0.00023035	-5.1253e-05	-0.0064458	0.00084408	0.0010131	-0.00034199	-0.13435	0.039498	-0.0065908	0.0081095	-0.0043232	0.0019749	-0.00013752	0.00031093	0.0011776	-3.4694e-18	-0.0006	0.0003	-0.0003	0.0003	-0.00070819	-9.7378e-05	0.0008616	-0.0056029	0.00074874	-0.00083198];
% b = [-0.031217	0.055002	-0.055002	0.055002	-0.075002	0.052383	-0.052383	0.052383	-0.052383	0.052383	-0.052383	0.052383	-0.025868	0.065868	-0.045868	0.065868	0.092465	0.080266	0.099734	0.037257	-0.037257	0.037257	-0.037257	0.037257	-0.037257	0.037257	0.046743	0.013257	0.093541	0.076459	0.09354	-0.09354	0.09354	0.027652	-0.027652	0.027652	-0.027652	0.027652	-0.027652	0.027652	-0.027652	0.0032426	-0.0032426	0.043243	0.047233	-0.047233	-0.041439	-0.058561	0.058561	-0.058561	-0.09608	-0.076651	-0.003349	0.083349	0.074984	-0.074984	-0.059527	0.059527	-0.059527	-0.040473	0.040473	-0.040473	0.060473	0.075241	0.09749	0.058318	0.046681	-0.046681	0.046681	-0.046681	0.046681	0.089033	0.083698	0.074635	-0.074635	0.074635	0.098096	0.037618	-0.037618	0.037618	-0.037618	0.037618	-0.037618	0.037618	0.017745	0.072731	0.1	0.1	-0.02	0.04	-0.02	0.04	-0.085238	-0.087493	0.064874	-0.064874	0.084874];
% c = [125.86	126	126	126	125	124	124	124	124	124	124	124	125	127	128	129	136	137	146	151	151	151	151	151	151	151	155	158	159	160	161	161	161	164	164	164	164	164	164	164	164	163	163	165	169	169	168	167	167	167	165	164	160	164	171	171	169	169	169	168	168	168	169	175	176	180	181	181	181	181	181	187	188	195	195	195	196	202	202	202	202	202	202	202	204	208	209	219	223	224	225	226	224	223	222	222	223];
% f=[a;b;c];
% visualize(f,pieces,f,pieces);

% pieces = [0	11.579	99.998	111.58	211.58	300	304.39	311.58	316.15	327.92	329.49	 ];
% a = [0.0037232	-0.00062206	0.0047494	-0.00065002	0.00072033	-0.011943	0.0072828	-0.011457	0.0044526	-0.033253	 ];
% b = [-0.031217	0.055002	-0.055002	0.055002	-0.075002	0.052383	-0.052383	0.052383	-0.052383	0.052383	 ];
% c = [125.86	126	126	126	125	124	124	124	124	124	 ];
% f=[a;b;c];
% visualize(f,pieces,f,pieces);

%%WORKS
% pieces = [0 20	40	60	80	100	120	140	160	180	200	220];
% a = [0.0031855	-0.005	0.005	-0.005	0	0	0.005	0	0	0	0];
% b = [-0.02742	0.1	-0.1	0.1	-0.1	-0.1	-0.1	0.1	0.1	0.1	0.1];
% c = [2012.3	2013	2013	2013	2013	2011	2009	2009	2011	2013	2015];
% f=[a;b;c];
% visualize(f,pieces,f,pieces);

a = [-0.0019795	-0.0025	0	0.0025	-0.0025	0	0	0	0	0	0	0	0	0	0.005	-0.0025	-0.0025	0.005	-0.005	-4.7835e-16	0.0050044];
b = [0.07918	0	-0.1	-0.1	0	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	0.1	0	-0.1	0.1	-0.1	-0.1];
c = [2316.2	2317	2316	2314	2313	2312	2310	2308	2306	2304	2302	2300	2298	2296	2294	2294	2295	2294	2294	2294	2292];
pieces = [0	20	40	60	80	100	120	140	160	180	200	220	240	260	280	300	320	340	360	380	400 419.98];
% a = [-0.0019795	-0.0025	0	0.0025	-0.0025	0	];
% b = [0.07918	0	-0.1	-0.1	0	-0.1	];
% c = [2316.2	2317	2316	2314	2313	2312	];
% pieces = [0	20	40	60	80	100	120];

% % % % % a = [	0.005	-0.0025	-0.0025	0.005	-0.005	-4.7835e-16	0.0050044];
% % % % % b = [	-0.1	0.1	0	-0.1	0.1	-0.1	-0.1];
% % % % % c = [		2294	2294	2295	2294	2294	2294	2292];
% % % % % pieces = [	280	300	320	340	360	380	400 419.98];


%%Sayan code
% a = [-0.00841434868521020	0.00999999999999972	-0.00999999999999943	0.00999999999999943	-0.00999999999999943	0.00999999999999943	-0.00999999999999972	0.00496470257911767	-0.00489410773735239	0.00985881031646923];
% 
% b = [0.0682869737042040	-0.100000000000000	0.0999999999999943	-0.0999999999999943	0.0999999999999943	-0.0999999999999943	0.0999999999999943	-0.100000000000000	-0.000705948417646596	-0.0985881031646944];
% 
% c = [1226.15856513148	1226	1226	1226	1226	1226	1226	1226	1225.49647025791	1225];
% 
% pieces = [0 10	20	30	40	50	60	70	80	90	100];
A=[];
B=[];
C=[];
for i=1:size(a,2)
    A = [A, a(i)];
    B = [B, -2*a(i)*pieces(i) + b(i)];
    C = [C, a(i)*pieces(i)^2 - b(i)*pieces(i) + c(i)];
end
f=[A;B;C];
% pieces = [0	20	40	60	80	100	120	140	160	180	200	220	240	260	280	300	320	340	360	380	400 420];


% f = [0.500000000000000	0.518437646505103	0.499999901680319	0	32.8683682153277	0;
% 0	0.917132524139069	-3.04688102464914e-06	0.0444741022508309	-486.948064672231	1;
% 1	12.4050899419419	0.999985038606479	2.08569551703759	1805.96086236474	-5;];
% 
% 
% pieces = [-30	-24.8711928576475	-24.8711428576475	-1.42976827671645	7.40822506843044	7.42279876684366	30];
% % % % % f = [0	0.257297125727798	0	0.123243838940298	0;
% % % % % -1.00000000003629	2.75156734845810	0	-1.09416144747544	1.00000000003629;
% % % % % -5.00000000057453	8.66275261463244	2.07106781186180	3.64578994435626	-5.00000000057456];
% % % % % 
% % % % % 
% % % % % 
% % % % % pieces = [-22	-7.07126084211892	-7.07102974841643	7.07103037564851	7.07125707785203	22];
% visualize_road(f,pieces,f,pieces);
% visualize(f,pieces,f,pieces);

 epsilon=0.00005;
% % % % % %%Example 1
% pieces = [-22, 1, 2.5, 6, 22];
% f = [
%     (1/2), 0, 0, 0;
%     0, 2, -1, 1;
%     1, -(1/2), 7, -5];


%%Example 2
% pieces = [-2, 0, 1, 2];
% f = [
%     0, 0, 0 ;
%     1, 0, -1 ;
%     2, 2, 3  ];
% 
% 
% pieces = [-100,-50,-25,-2, 0, 1, 2,25,50,100];
% f = [
%     0,0,0,0, 0, 0,0,0,0 ;
%     1,1,1,1, 0, -1,-1,-1,-1 ;
%     2,2,2,2, 2, 3,3,3,3  ];
% % pieces = [-22, -5, 0, 5, 22];
% % f = [0, 0, 0, 0;
% %     -1, 1, -1, 1;
% %     -5, 5, 5, -5];
% visualize(f, pieces, f,pieces); 
% [rho,new_pieces,  objective]  = nearest_convex_function_variable_pieces(f,pieces);
no_of_pieces = size(f,2)*3;%%Not working
% no_of_pieces = size(f,2)*5; %Working = why?
no_of_pieces = size(f,2)+1
% %   [rho,new_pieces,  objective]  = nearest_convex_function_variable_pieces_of_fixed_num(f,pieces,no_of_pieces);
% % [rho,new_pieces]  = algo1(f,pieces,no_of_pieces);
% %  [simple_rho,simple_rho_pieces ] = simple_merging_based_on_values(rho,new_pieces, epsilon);
tStarttic = tic;  
 [simple_rho,simple_rho_pieces ] = simple_merging_based_on_values(f, pieces, epsilon);
%  visualize(f, pieces,simple_rho,simple_rho_pieces); 
% % %    visualize(rho,new_pieces,simple_rho,simple_rho_pieces);
% visualize(f, pieces,simple_rho,simple_rho_pieces);

%   [g,g_pieces, num_of_pieces] = decrease_pieces_of_convex_function(simple_rho,simple_rho_pieces, epsilon, @nget_nearest_convex_function_with_variable_pieces_of_given_num);
 [g,g_pieces, num_of_pieces] = decrease_pieces_of_convex_function(simple_rho(1:3,1:6),simple_rho_pieces(1,1:7), epsilon, @ngetexp_nearest_function_with_variable_pieces_of_given_num);
[g,g_pieces, num_of_pieces] = decrease_pieces_of_convex_function(simple_rho(1:3,6:end),simple_rho_pieces(1,6:end), epsilon, @ngetexp_nearest_function_with_variable_pieces_of_given_num);
% [g,g_pieces, num_of_pieces] = decrease_pieces_of_convex_function(simple_rho ,simple_rho_pieces , epsilon, @ngetexp_nearest_function_with_variable_pieces_of_given_num);
endtic=toc(tStarttic)
disp(g_pieces)
disp(g)
visualize(f, pieces,g,g_pieces);

% [simple_f,simple_f_pieces ] = simple_merging_based_on_values(f,pieces, epsilon);
% visualize(f,pieces,simple_f,simple_f_pieces);
% [g,g_pieces, num_of_pieces] = decrease_pieces_of_convex_function(simple_f,simple_f_pieces, epsilon, @get_nearest_function_with_variable_pieces_of_given_num);

g=[0.499085056356920	-0.267462858126033	0.0312722114521228;
-0.0152945882831779	1.51780124068273	0.0241258927920253;
1.01134730088109	0.244799386398137	2.11189357126142]
g_pieces = [-22	1	2.50000000000000	22];
% visualize(f, pieces,g,g_pieces);
% [g,g_pieces, num_of_pieces] = decrease_pieces_of_convex_function( simple_rho,simple_rho_pieces , epsilon, @nget_nearest_function_with_variable_pieces_of_given_num);


%%Example 3
% f=[-0.120079071320764	-0.695238896399100	-0.294835127792533
% 0.731325706616329	0.731325706616329	-0.0694818305968040
% 1.88517833109613	1.88517833109613	2.28558209970270];
% pieces = [-2	0	1	2];


%%Example 1
% pieces = [-22, 1, 2.5, 6, 22];
% f = [
%     (1/2), 0, 0, 0;
%     0, 2, -1, 1;
%     1, -(1/2), 7, -5];

%example 4-not working
% pieces = [-32,-10,-15, -5, 0, 5, 10,15,32];
% f = [1,1,1, 1, 1, 1,1,1;
%     1,1,1, 1, -1, 1,1,1;
%     5,5,5, 5, 5, -5,-5,-5];

[g,g_pieces, num_of_pieces] = decrease_pieces_of_convex_function( f,pieces, epsilon, @ngetexp_nearest_function_with_variable_pieces_of_given_num);
visualize(f, pieces,g,g_pieces);

% epsilon=100;
% [rho,new_pieces,  objective]  = nearest_convex_function_variable_pieces(f,pieces);
% [simple_rho,simple_rho_pieces ] = simple_merging_based_on_values(f,pieces, epsilon);
% visualize(rho,new_pieces,simple_rho,simple_rho_pieces);
% [g,g_pieces, num_of_pieces] = decrease_pieces_of_convex_function(f,pieces, epsilon, @get_nearest_function_with_variable_pieces_of_given_num);
% visualize(rho,new_pieces,g,g_pieces);
% [g,g_pieces, num_of_pieces] = decrease_pieces_of_convex_function(simple_rho,simple_rho_pieces, epsilon);

% [g,g_pieces, num_of_pieces] = decrease_pieces_of_convex_function(rho,new_pieces, epsilon);

% disp(value(objective))
% disp(size(new_pieces,2)-1)
% disp( num_of_pieces )



% g_pieces = convert_to_values(g_pieces);
% rho_vals = convert_to_values_rho(g);
% 
g_pieces= [0 40 60 80 100 280 300 340 360	380	400	419.980000000000];

 

g=[-0.0025,0, 0.0025, -0.00250, 0, 0.0050,-0.0025, 0.0050, -0.005, -4.78350000000000e-16, 0.005004400;
0.1 ,-0.1, -0.40, 0.40, -0.1,-2.9, 1.6, -3.5, 3.7, -0.1, -4.103520;
2316 ,2320, 2329, 2297, 2322, 2714, 2039, 2906, 1610, 2331.99999999993, 3132.7040;
];
 
visualize(f,pieces,g,g_pieces);

% visualize(rho,new_pieces,g,g_pieces);



function val = convert_to_values(new_pieces)
    val = [];
    for i=1:size(new_pieces,2)
        val = [val value(new_pieces(i))];
    end        
end


function val = convert_to_values_rho(rho)
    val = [];
    for i=1:size(rho,1)
        val_row = [];
        for j=1:size(rho,2)
            val_row = [val_row value(rho(i,j))];
        end
        val = [val; val_row];
    end    
end
