yalmip('clear')
% a = [-0.0019795	-0.0025	0	0.0025	-0.0025	0	0	0	0	0	0	0	0	0	0.005	-0.0025	-0.0025	0.005	-0.005	-4.7835e-16	0.0050044];
% b = [0.07918	0	-0.1	-0.1	0	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	0.1	0	-0.1	0.1	-0.1	-0.1];
% c = [2316.2	2317	2316	2314	2313	2312	2310	2308	2306	2304	2302	2300	2298	2296	2294	2294	2295	2294	2294	2294	2292];
% sId = [0	20	40	60	80	100	120	140	160	180	200	220	240	260	280	300	320	340	360	380	400];
% eId = [20	40	60	80	100	120	140	160	180	200	220	240	260	280	300	320	340	360	380	400	419.98];
% f=[a;b;c];
% pieces = [0	20	40	60	80	100	120	140	160	180	200	220	240	260	280	300	320	340	360	380	400	419.98 ];
% visualize(f,pieces,f,pieces);
% pieces = [0	20	40	60	80	100	120	140	149.07	160	180	200	220	240	260	261.36	280	300	320	340	360	380	388.83	400	420	440	460 473.74];
%  a = [0.001448	-0.0025	0	0	0.0025	-0.0025	1.4225e-16	0.011026	-0.0091484	0	0	0	0	0	0.073752	-0.0053636	-1.0187e-15	5.0914e-16	0	0	2.55e-16	0.01132	-0.0089559	0	0	0	0.0019803];
% b = [-0.05792	0	-0.1	-0.1	-0.1	0	-0.1	-0.1	0.1	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	0.1	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	0.1	-0.1	-0.1	-0.1	-0.1];
% c = [1912.6	1912	1911	1909	1907	1906	1905	1903	1903	1903	1901	1899	1897	1895	1893	1893	1893	1891	1889	1887	1885	1883	1883	1883	1881	1879	1877];
% f=[a;b;c];
% pieces = [0	20	40	60	80	100	120	140	149.07	160 ];
%  a = [0.001448	-0.0025	0	0	0.0025	-0.0025	1.4225e-16	0.011026	-0.0091484	 ];
% b = [-0.05792	0	-0.1	-0.1	-0.1	0	-0.1	-0.1	0.1	 ];
% c = [1912.6	1912	1911	1909	1907	1906	1905	1903	1903	 ];
% f=[a;b;c];
% visualize(f,pieces,f,pieces);
% 
% pieces = [-inf(),-10,-15, -5, 0, 5, 10,15,inf()];
% f = [0,0,0, 0, 0, 0,0,0;
%     1,1,1, 1, -1, 1,1,1;
%     5,5,5, 5, 5, -5,-5,-5];


% pieces = [0	11.579	99.998	111.58	211.58	300	304.39	311.58	316.15	327.92	329.49	336.15	411.58	511.58	611.58	711.58	800	811.58	911.58	984.58	991.24	992.81	1000	1004.6	1011.6	1016.3	1111.6	1211.6	1230.3	1242.1	1253.8	1255.4	1262.1	1311.6	1386.3	1393	1394.5	1400	1406.3	1411.6	1418.1	1500	1511.6	1611.6	1700	1711.6	1734.1	1754.1	1767.5	1774.1	1800	1811.6	1911.6	2011.6	2100	2111.6	2141.3	2148	2161.3	2181.3	2200	2211.6	2311.6	2400	2411.6	2462.9	2482	2495.3	2501	2502	2511.6	2600	2611.6	2700	2711.6	2800	2811.6	2900	2900.3	2901.2	2906.9	2911.6	2920.3	2939.3	3011.6	3100	3111.6	3211.6	3311.6	3411.6	3511.6	3611.6	3700	3711.6	3800	3811.6	3911.6 4000];
% a = [0.0037232	-0.00062206	0.0047494	-0.00065002	0.00072033	-0.011943	0.0072828	-0.011457	0.0044526	-0.033253	0.0078653	-0.00051871	0.00045868	-0.00055868	0.00055868	0.0001504	-0.00052681	9.7343e-05	-0.00042794	-0.0055942	0.023651	-0.0051827	0.0081421	-0.0053203	0.007824	4.9799e-05	-0.00016743	0.0021435	-0.00072598	0.00072591	-0.059383	0.014045	-0.00066542	-0.00037007	0.004152	-0.017553	0.0050597	-0.0043895	0.005238	-0.0042636	0.00018853	-0.00028005	0.00023243	2.2566e-05	-0.0040793	0.00012844	-0.00042804	0.0043899	-0.0087929	-0.00072525	0.000839	0.00036651	0.00043349	-4.7303e-05	-0.006476	0.00025989	0.008938	-0.0044623	0.00047634	0.0021662	-0.0034955	0.00050473	8.3508e-05	0.00096079	-0.00038146	-0.00030547	-0.0034993	0.0081788	-0.049014	0.004859	0.00023949	-0.00023035	-5.1253e-05	-0.0064458	0.00084408	0.0010131	-0.00034199	-0.13435	0.039498	-0.0065908	0.0081095	-0.0043232	0.0019749	-0.00013752	0.00031093	0.0011776	-3.4694e-18	-0.0006	0.0003	-0.0003	0.0003	-0.00070819	-9.7378e-05	0.0008616	-0.0056029	0.00074874	-0.00083198];
% b = [-0.031217	0.055002	-0.055002	0.055002	-0.075002	0.052383	-0.052383	0.052383	-0.052383	0.052383	-0.052383	0.052383	-0.025868	0.065868	-0.045868	0.065868	0.092465	0.080266	0.099734	0.037257	-0.037257	0.037257	-0.037257	0.037257	-0.037257	0.037257	0.046743	0.013257	0.093541	0.076459	0.09354	-0.09354	0.09354	0.027652	-0.027652	0.027652	-0.027652	0.027652	-0.027652	0.027652	-0.027652	0.0032426	-0.0032426	0.043243	0.047233	-0.047233	-0.041439	-0.058561	0.058561	-0.058561	-0.09608	-0.076651	-0.003349	0.083349	0.074984	-0.074984	-0.059527	0.059527	-0.059527	-0.040473	0.040473	-0.040473	0.060473	0.075241	0.09749	0.058318	0.046681	-0.046681	0.046681	-0.046681	0.046681	0.089033	0.083698	0.074635	-0.074635	0.074635	0.098096	0.037618	-0.037618	0.037618	-0.037618	0.037618	-0.037618	0.037618	0.017745	0.072731	0.1	0.1	-0.02	0.04	-0.02	0.04	-0.085238	-0.087493	0.064874	-0.064874	0.084874];
% c = [125.86	126	126	126	125	124	124	124	124	124	124	124	125	127	128	129	136	137	146	151	151	151	151	151	151	151	155	158	159	160	161	161	161	164	164	164	164	164	164	164	164	163	163	165	169	169	168	167	167	167	165	164	160	164	171	171	169	169	169	168	168	168	169	175	176	180	181	181	181	181	181	187	188	195	195	195	196	202	202	202	202	202	202	202	204	208	209	219	223	224	225	226	224	223	222	222	223];
% f=[a;b;c];
% visualize(f,pieces,f,pieces);

% pieces = [0	11.579	99.998	111.58	211.58	300	304.39	311.58	316.15	327.92	329.49	 ];
% a = [0.0037232	-0.00062206	0.0047494	-0.00065002	0.00072033	-0.011943	0.0072828	-0.011457	0.0044526	-0.033253	 ];
% b = [-0.031217	0.055002	-0.055002	0.055002	-0.075002	0.052383	-0.052383	0.052383	-0.052383	0.052383	 ];
% c = [125.86	126	126	126	125	124	124	124	124	124	 ];
% f=[a;b;c];
% visualize(f,pieces,f,pieces);

%%WORKS
% pieces = [0 20	40	60	80	100	120	140	160	180	200	220];
% a = [0.0031855	-0.005	0.005	-0.005	0	0	0.005	0	0	0	0];
% b = [-0.02742	0.1	-0.1	0.1	-0.1	-0.1	-0.1	0.1	0.1	0.1	0.1];
% c = [2012.3	2013	2013	2013	2013	2011	2009	2009	2011	2013	2015];
% f=[a;b;c];
% visualize(f,pieces,f,pieces);

a = [-0.0019795	-0.0025	0	0.0025	-0.0025	0	0	0	0	0	0	0	0	0	0.005	-0.0025	-0.0025	0.005	-0.005	-4.7835e-16	0.0050044];
b = [0.07918	0	-0.1	-0.1	0	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	-0.1	0.1	0	-0.1	0.1	-0.1	-0.1];
c = [2316.2	2317	2316	2314	2313	2312	2310	2308	2306	2304	2302	2300	2298	2296	2294	2294	2295	2294	2294	2294	2292];
pieces = [0	20	40	60	80	100	120	140	160	180	200	220	240	260	280	300	320	340	360	380	400 419.98];
% a = [-0.0019795	-0.0025	0	0.0025	-0.0025	0	];
% b = [0.07918	0	-0.1	-0.1	0	-0.1	];
% c = [2316.2	2317	2316	2314	2313	2312	];
% pieces = [0	20	40	60	80	100	120];

% % % % % a = [	0.005	-0.0025	-0.0025	0.005	-0.005	-4.7835e-16	0.0050044];
% % % % % b = [	-0.1	0.1	0	-0.1	0.1	-0.1	-0.1];
% % % % % c = [		2294	2294	2295	2294	2294	2294	2292];
% % % % % pieces = [	280	300	320	340	360	380	400 419.98];


%%Sayan code
% a = [-0.00841434868521020	0.00999999999999972	-0.00999999999999943	0.00999999999999943	-0.00999999999999943	0.00999999999999943	-0.00999999999999972	0.00496470257911767	-0.00489410773735239	0.00985881031646923];
% 
% b = [0.0682869737042040	-0.100000000000000	0.0999999999999943	-0.0999999999999943	0.0999999999999943	-0.0999999999999943	0.0999999999999943	-0.100000000000000	-0.000705948417646596	-0.0985881031646944];
% 
% c = [1226.15856513148	1226	1226	1226	1226	1226	1226	1226	1225.49647025791	1225];
% 
% pieces = [0 10	20	30	40	50	60	70	80	90	100];
A=[];
B=[];
C=[];
for i=1:size(a,2)
    A = [A, a(i)];
    B = [B, -2*a(i)*pieces(i) + b(i)];
    C = [C, a(i)*pieces(i)^2 - b(i)*pieces(i) + c(i)];
end
f=[A;B;C];
% pieces = [0	20	40	60	80	100	120	140	160	180	200	220	240	260	280	300	320	340	360	380	400 420];


% f = [0.500000000000000	0.518437646505103	0.499999901680319	0	32.8683682153277	0;
% 0	0.917132524139069	-3.04688102464914e-06	0.0444741022508309	-486.948064672231	1;
% 1	12.4050899419419	0.999985038606479	2.08569551703759	1805.96086236474	-5;];
% 
% 
% pieces = [-30	-24.8711928576475	-24.8711428576475	-1.42976827671645	7.40822506843044	7.42279876684366	30];
% % % % % f = [0	0.257297125727798	0	0.123243838940298	0;
% % % % % -1.00000000003629	2.75156734845810	0	-1.09416144747544	1.00000000003629;
% % % % % -5.00000000057453	8.66275261463244	2.07106781186180	3.64578994435626	-5.00000000057456];
% % % % % 
% % % % % 
% % % % % 
% % % % % pieces = [-22	-7.07126084211892	-7.07102974841643	7.07103037564851	7.07125707785203	22];
% visualize_road(f,pieces,f,pieces);
% visualize(f,pieces,f,pieces);

 epsilon=0.00005;
% % % % % %%Example 1
pieces = [-22, 1, 2.5, 6, 22];
f = [
    (1/2), 0, 0, 0;
    0, 2, -1, 1;
    1, -(1/2), 7, -5];


%%Example 2
% pieces = [-2, 0, 1, 2];
% f = [
%     0, 0, 0 ;
%     1, 0, -1 ;
%     2, 2, 3  ];
% 
% 
% pieces = [-100,-50,-25,-2, 0, 1, 2,25,50,100];
% f = [
%     0,0,0,0, 0, 0,0,0,0 ;
%     1,1,1,1, 0, -1,-1,-1,-1 ;
%     2,2,2,2, 2, 3,3,3,3  ];
% % % pieces = [-22, -5, 0, 5, 22];
% % % f = [0, 0, 0, 0;
% % %     -1, 1, -1, 1;
% % %     -5, 5, 5, -5];
% visualize(f, pieces, f,pieces); 
% [rho,new_pieces,  objective]  = nearest_convex_function_variable_pieces(f,pieces);
no_of_pieces = size(f,2)*3;%%Not working
% no_of_pieces = size(f,2)*5; %Working = why?
tictoctime=[];
objs=[];
yalmiptime=[];
solvertime=[];
numpc=[];
for gran = 1:100
        no_of_pieces = size(f,2)+gran;

      [rho,new_pieces,  objective]  = nearest_convex_function_variable_pieces_of_fixed_num(f,pieces,no_of_pieces);


        tStarttic = tic;  

% % [rho,new_pieces]  = algo1(f,pieces,no_of_pieces);
 [simple_rho,simple_rho_pieces ] = simple_merging_based_on_values(rho,new_pieces, epsilon);
[g,g_pieces, num_of_pieces,objective,sol] = decrease_pieces_of_convex_function(simple_rho ,simple_rho_pieces , epsilon, @ngetexp_nearest_function_with_variable_pieces_of_given_num);
% [g,g_pieces, num_of_pieces,objective,sol] = decrease_pieces_of_convex_function(rho,new_pieces , epsilon, @ngetexp_nearest_function_with_variable_pieces_of_given_num);
endtic=toc(tStarttic);
tictoctime = [tictoctime, endtic];
objs = [objs, objective];
yalmiptime = [yalmiptime, sol.yalmiptime];
solvertime = [solvertime, sol.solvertime];
numpc = [numpc, no_of_pieces];
end
disp(g_pieces)
disp(g)
visualize(f, pieces,g,g_pieces);


tictoctime = [306.022153500000	322.660440000000	309.791613700000	357.827745400000	363.274779200000	305.953298500000	5.05107430000000	393.547658500000	312.638080100000	310.984189600000	313.491138100000	599.981334100000	7.86159680000000	325.051041800000	7.43564280000000	8.24070640000000	408.568610200000	451.480030400000	307.025913700000	5.01406810000000	441.574875300000	306.912955200000	313.792438800000	349.137590200000	391.328754000000	5.97654030000000	7.28555080000000	8.17866290000000	5.79305250000000	310.029821000000	594.288134400000	441.721634400000	361.955863700000	5.10085830000000	5.62685560000000	332.333472100000	493.483364300000	6.71291880000000	8.07531410000000	373.328886000000	8.48924260000000	7.50146360000000	533.437751600000	9.36726650000000	312.003318800000	7.61522900000000	7.80998010000000	7.69432880000000	8.30229710000000	424.190698700000	364.989886400000	8.43967780000000	7.47255230000000	310.321232200000	9.24804140000000	14.9094705000000	332.180976200000	9.33827220000000	470.138537800000	8.23115840000000	14.1492342000000	12.5077490000000	356.475960400000	10.4798925000000	13.8881751000000	12.6329379000000	10.6668699000000	16.9552063000000	12.6450550000000	10.7282138000000	11.5093118000000	12.5608811000000	13.0645058000000	11.6266161000000	12.8496371000000	11.1438145000000	10.7024841000000	318.442497600000	13.4625654000000	10.6099483000000	11.4463213000000	11.3797602000000	13.8912817000000	12.3788213000000	10.6168733000000	12.8717546000000	319.016607600000	313.162300000000	319.229011200000	21.3441507000000	382.485378300000	541.859045800000	13.1214773000000	13.1640965000000	12.1740951000000	484.589434100000	22.5013022000000	14.2629876000000	13.7872756000000	24.9334029000000];
objs = [262926.596532039	12.8805213808844	12.8784662731723	6.80156541242486	45.2018288915644	45.2018821445736	1739.80774580496	8.81652794055117	12.8743702448266	12.8770010586427	12.8804432331341	131.219397371180	NaN	44.5022721168416	6825.54095405318	NaN	55.0029969171239	6.07366127193097	6.07442570965185	55.1230521142467	6.09876586580593	12.8708035845784	11.5608273731764	8.21866244266354	9.41388297317621	4544.48713603440	44.2260783806095	4707.26711407006	NaN	12.8704236506104	718.458101995170	7.16200865692412	54.2161712021325	NaN	NaN	12.8678034516410	6.53943193137309	NaN	5073.42917560777	12.8720286293365	NaN	NaN	12.4410248565624	4297.84313697461	12.0377937299828	NaN	NaN	NaN	NaN	6.08527486245625	12.8827699347883	NaN	NaN	12.8808111025539	3672.19239680555	NaN	728.166169752255	NaN	1180.19660031425	NaN	NaN	NaN	17.4900153981211	NaN	NaN	NaN	NaN	NaN	NaN	7164.33618335042	NaN	NaN	NaN	NaN	NaN	NaN	NaN	54.2115960212492	NaN	862.996071861428	61.2526328907275	4528.07390403891	NaN	NaN	55.3845004478418	45.4742491802799	12.8418529846676	6.33044506929374	12.8525832944260	NaN	45.2036692959906	6.79130237989667	41.4736125102874	NaN	278.993474589705	7031.01951397703	NaN	NaN	800.570767208776	NaN];
solvertime = [303.360668100000	320.453474400000	307.759618500000	354.945333600000	360.865341500000	303.569615500000	1.74299850000000	391.140502900000	310.529239400000	308.979262100000	310.798415500000	596.546568700000	4.06682370000000	321.901287900000	3.46694640000000	3.89050570000000	405.454501000000	448.191073400000	304.508612700000	2.22380600000000	438.838137300000	304.247326100000	311.139569900000	345.892164600000	387.342322700000	2.03364240000000	3.17811930000000	4.32691630000000	2.72589540000000	307.702186900000	591.694401600000	438.809150500000	359.120348600000	1.39242170000000	1.68174140000000	329.901023300000	488.547492500000	1.86599510000000	2.14324550000000	369.437866900000	3.45508540000000	1.65680040000000	528.818706900000	4.55486870000000	307.551649200000	2.04863020000000	1.56587630000000	2.19557460000000	2.85760010000000	419.511955500000	360.448200000000	2.73614630000000	1.61770620000000	306.073395300000	3.22751440000000	4.86922660000000	326.842217600000	1.66915920000000	464.593485600000	1.96170380000000	2.47333080000000	2.19112570000000	350.318086200000	1.76800850000000	2.30013720000000	2.45184370000000	1.56725590000000	2.96238880000000	2.98988040000000	3.23830630000000	1.88577550000000	3.94621150000000	5.00391110000000	1.82228580000000	2.15163950000000	1.64619200000000	1.66042970000000	311.273532900000	3.96239560000000	2.32810500000000	2.82336810000000	2.10171800000000	1.98454000000000	1.49244850000000	2.37965140000000	3.54359410000000	311.780847300000	305.911704100000	311.875941700000	4.33217090000000	375.038846200000	532.066451900000	2.89252220000000	1.68460020000000	2.11414710000000	475.778934400000	2.38482190000000	1.53640650000000	2.36736440000000	3.45126740000000];
yalmiptime = [0.574331900000004	0.410525599999971	0.236381499999993	0.407666399999982	0.448658500000022	0.371384499999976	0.518001500000000	0.448497099999941	0.283760599999994	0.214737899999989	0.426584500000047	0.519431300000065	0.601176300000000	0.449712099999999	0.570053599999999	0.633494300000001	0.448499000000027	0.486926600000004	0.424387299999978	0.436193999999996	0.493862699994850	0.253673899999967	0.409430099999952	0.475835399999994	0.501677299999983	0.563357600000001	0.456880700000000	0.320083700000002	0.352104599999996	0.267813100000012	0.291598399999998	0.277849500000002	0.290651400000002	0.426578300000001	0.419258599999999	0.216976699999918	0.581507500000043	0.645004900000003	0.718754499999998	0.462133099999960	0.584914599999999	0.766199599999995	0.467293100000006	0.545131299999998	0.458350800000005	0.698369800000000	0.758123700000000	0.667425400000000	0.614399900000000	0.509044500000016	0.482799999999997	0.644853700000000	0.724293799999999	0.459604700000000	0.704485600000000	1.20977340000000	0.563782399999923	0.888840800000000	0.601514399999985	0.728296200000001	1.39966920000000	1.18587430000000	0.744913800000006	0.904991500000000	1.37986280000000	0.968156300000000	0.926744100000000	1.46461120000000	0.884119599999999	0.701693700000005	0.876224500000000	0.800788500000000	0.678088900000002	0.801714200000002	0.934360500000000	0.813807999999994	0.814570300000002	0.593467099999998	0.776604399999997	0.655895000000002	0.706631900000001	0.702281999999999	0.980460000000000	0.844551499999996	0.634348599999999	0.706405900000000	0.536152700000002	0.551295900000014	0.504058299999997	1.26982910000000	0.555153799999971	0.714548100000002	0.741477800000000	0.838399800000000	0.721852899999999	0.626065600000175	1.45317810000000	0.862593500000000	0.806635600000000	1.50873260000000];


function val = convert_to_values(new_pieces)
    val = [];
    for i=1:size(new_pieces,2)
        val = [val value(new_pieces(i))];
    end        
end


function val = convert_to_values_rho(rho)
    val = [];
    for i=1:size(rho,1)
        val_row = [];
        for j=1:size(rho,2)
            val_row = [val_row value(rho(i,j))];
        end
        val = [val; val_row];
    end    
end
